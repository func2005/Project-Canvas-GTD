# Project Canvas GTD: ç©ºé—´åŒ–ä»»åŠ¡ç®¡ç†ç³»ç»Ÿè®¾è®¡ç™½çš®ä¹¦

**ç‰ˆæœ¬**: 6.0 (å®æ–½ç‰ˆ)
**æ—¥æœŸ**: 2025-11-21
**æ¶æ„åŸºç¡€**: Local-First (RxDB + PostgreSQL)
**çŠ¶æ€**: å·²å®šç¨¿

---

## 1. é¡¹ç›®æ„¿æ™¯

æœ¬é¡¹ç›®æ—¨åœ¨æ„å»ºä¸€ä¸ªåŸºäº **ç”»å¸ƒ** çš„ä¸‹ä¸€ä»£ GTD å·¥ä½œç©ºé—´ã€‚

### æ ¸å¿ƒç†å¿µ
1.  **ç©ºé—´åŒ–**ï¼šæ‰“ç ´ä¼ ç»Ÿåˆ—è¡¨çš„çº¿æ€§é™åˆ¶ï¼Œåˆ©ç”¨äºŒç»´ç©ºé—´çš„â€œä½ç½®â€å’Œâ€œè¿æ¥â€æ¥ç»„ç»‡ä¸Šä¸‹æ–‡ã€‚
2.  **ç»„ä»¶å®ä¾‹åŒ–**ï¼šè§†å›¾ï¼ˆæ—¥å†ã€åˆ—è¡¨ã€çŸ©é˜µï¼‰ä¸å†æ˜¯å•ä¾‹é¡µé¢ï¼Œè€Œæ˜¯ç”»å¸ƒä¸Šå¯æ— é™å¤ç”¨çš„ç»„ä»¶å®ä¾‹ (`canvas_widgets`)ã€‚
3.  **æœ¬åœ°ä¼˜å…ˆ**ï¼šé‡‡ç”¨ RxDB + PostgreSQL æ¶æ„ã€‚æ•°æ®ä¼˜å…ˆå­˜å‚¨åœ¨æœ¬åœ°ï¼Œé€šè¿‡å¢é‡å¤åˆ¶åè®®ä¸äº‘ç«¯åŒæ­¥ï¼Œä»¥æé«˜å“åº”é€Ÿåº¦ã€‚
4.  **æ•°æ®ä¸è§†å›¾åˆ†ç¦»**ï¼šä¸šåŠ¡æ•°æ® (`Data Store`) æ˜¯å”¯ä¸€çš„æ•°æ®æ¥æºï¼Œè€Œç”»å¸ƒ (`Canvas Store`) ä»…æ˜¯æ•°æ®çš„æŠ•å½±æ–¹å¼ã€‚

---

## 2. æ ¸å¿ƒå®ä½“å®šä¹‰ (Core Taxonomy)

### 2.1 Task (ä»»åŠ¡) â€”â€” "è½¯æ—¶é—´"ä¸"è‡ªæˆ‘æ’ç¨‹"

-   **å®šä¹‰**ï¼šéœ€è¦ç”¨æˆ·ä¸»åŠ¨æ‰§è¡Œçš„åŸå­è¡ŒåŠ¨ (`entity_type = 'task'`)ã€‚
-   **æ—¶é—´è¡Œä¸ºæ‰©å……**ï¼š
    -   é€šå¸¸ä»…æœ‰ `do_date` (åœ¨é‚£å¤©åš)ã€‚
    -   **Time Blocking (æ—¶é—´å—)**ï¼šTask ä¹Ÿå¯ä»¥æ‹¥æœ‰ `start_time` å’Œ `end_time`ã€‚è¿™æ„å‘³ç€ç”¨æˆ·å†³å®šâ€œè‡ªæˆ‘çº¦æŸâ€ï¼Œåœ¨ç‰¹å®šæ—¶é—´æ®µä¸“æ³¨å¤„ç†è¯¥ä»»åŠ¡ã€‚
-   **æ ¸å¿ƒç»´åº¦ (å­˜å‚¨äº `properties` JSONB)**ï¼š
    1.  **çº¦æŸ**ï¼š`due_date` (æ­»çº¿ï¼Œç¡¬å­—æ®µ)ã€‚
    2.  **æ„å›¾**ï¼š`do_date` (è®¡åˆ’æ—¥) + å¯é€‰çš„ Time Blockã€‚
    3.  **æƒé‡**ï¼š`properties.priority` + `sort_order` (æ‰‹åŠ¨æ’åºæƒé‡)ã€‚
    4.  **æˆæœ¬**ï¼š`properties.energy_level`ã€‚

### 2.2 Event (äº‹ä»¶/æ—¥ç¨‹) â€”â€” "ç¡¬æ—¶é—´"ä¸"å¤–éƒ¨å¥‘çº¦"

-   **å®šä¹‰**ï¼šå…·æœ‰æ’ä»–æ€§çš„ã€é€šå¸¸æ¶‰åŠä»–äººçš„å›ºå®šäº‹åŠ¡ (`entity_type = 'event'`)ã€‚
-   **é‡å¤æ€§ (Recurrence)**ï¼š
    -   Event æ”¯æŒ iCal æ ‡å‡†çš„ `recurrence_rule`ï¼Œä¾‹å¦‚â€œæ¯å‘¨ä¸€ä¸Šåˆ10ç‚¹â€ã€‚
    -   *ä¾‹å¤–å¤„ç†*ï¼šä¿®æ”¹é‡å¤äº‹ä»¶çš„æŸä¸€æ¬¡ä¼šç”Ÿæˆä¸€ä¸ªæ–°è®°å½•ï¼Œå…¶ `original_event_id` æŒ‡å‘çˆ¶è§„åˆ™ IDã€‚
-   **Canvas å½¢æ€**ï¼šå§‹ç»ˆæ˜¾ç¤ºä¸ºæ—¶é—´è½´ä¸Šçš„å®å¿ƒè‰²å—ã€‚

### 2.3 Project (é¡¹ç›®) â€”â€” èšåˆæ ‡ç­¾

-   **å®šä¹‰**ï¼šä¸€ä¸ªéœ€è¦å¤šæ­¥æ“ä½œæ‰èƒ½å®Œæˆçš„ç»“æœ (`entity_type = 'project'`)ã€‚å®ƒæ˜¯ Task å’Œ Event çš„çˆ¶çº§ (`parent_id`)ã€‚
-   **æ ¸å¿ƒçŠ¶æ€**ï¼š
    1.  **æ´»è·ƒ (Active)**ï¼šé¡¹ç›®ä¸­è‡³å°‘åŒ…å«ä¸€ä¸ª `active` çš„ Taskã€‚
    3.  **å®Œæˆ (Completed)**ï¼šæ‰€æœ‰å­ä»»åŠ¡å‡å·²å½’æ¡£ã€‚
-   **äº¤äº’**ï¼šå¯å±•å¼€ä¸ºä¸€ç»„ç‹¬ç«‹çš„çœ‹æ¿è§†å›¾ç»„ä»¶ã€‚

---

## 3. æ•°æ®åº“æ¶æ„è®¾è®¡ (Database Schema)

æœ¬ç³»ç»Ÿé‡‡ç”¨ **åŒæ ¸éš”ç¦»æ¶æ„**ï¼šä¸šåŠ¡æ•°æ® (`data_*`) ä¸ è§†å›¾é…ç½® (`canvas_*`) åˆ†ç¦»ã€‚

### 3.1 ä¸šåŠ¡æ•°æ®å±‚ (Data Layer) - The Source of Truth

æ ¸å¿ƒè¡¨ï¼š`data_items`ã€‚æ‰¿è½½æ‰€æœ‰ GTD å®ä½“ã€‚

| å­—æ®µå (Column) | ç±»å‹ | è¯´æ˜ (Description) |
| :--- | :--- | :--- |
| **id** | UUID | ä¸»é”®ã€‚ |
| **user_id** | UUID | å¤šç§Ÿæˆ·éš”ç¦»ã€‚ |
| **entity_type** | String | `'task'`, `'event'`, `'project'`ã€‚ |
| **system_status** | String | `'active'`, `'waiting'`,`'completed'`, `'dropped'`, `'archived'`ã€‚ |
| **title** | Text | äº‹åŠ¡æ ‡é¢˜ã€‚ |
| **parent_id** | UUID | æŒ‡å‘ Project ID æˆ– Event ID (ä½œä¸ºå­ä»»åŠ¡)ã€‚ |
| **do_date** | Date | Task è®¡åˆ’æ‰§è¡Œæ—¥æœŸã€‚ |
| **due_date** | Timestamp | Task æˆªæ­¢æ­»çº¿ã€‚ |
| **start_time / end_time** | Timestamp | Event å¿…å¡«ï¼›Task é€‰å¡« (Time Block)ã€‚ |
| **sort_order** | Numeric | ç”¨äºåˆ—è¡¨å†…çš„æ‰‹åŠ¨æ‹–æ‹½æ’åº (Lexicographical Rank)ã€‚ |
| **recurrence_rule** | Text | iCal è§„åˆ™å­—ç¬¦ä¸²ã€‚ |
| **original_event_id** | UUID | æŒ‡å‘é‡å¤äº‹ä»¶çš„çˆ¶ IDã€‚ |
| **properties** | JSONB | **[æ‰©å±•åŒ…]** åŒ…å« `priority`, `energy_level`, `tags`, `content` (Markdown)ã€‚ |
| **is_all_day** | Boolean | æ˜¯å¦å…¨å¤©äº‹ä»¶ã€‚ |
| **created_at** | BigInt | åˆ›å»ºæ—¶é—´æˆ³ (ms)ã€‚ |
| **completed_at** | BigInt | å®Œæˆæ—¶é—´æˆ³ (ms)ã€‚ |
| **updated_at** | Timestamp | ç”¨äº RxDB å¢é‡åŒæ­¥ã€‚ |
| **deleted** | Boolean | è½¯åˆ é™¤æ ‡è®°ã€‚ |

### 3.2 è§†å›¾é…ç½®å±‚ (Presentation Layer) - The Canvas

æ ¸å¿ƒè¡¨ï¼š`canvas_widgets`ã€‚å†³å®šç”¨æˆ·çœ‹åˆ°ä»€ä¹ˆã€‚

| å­—æ®µå (Column) | ç±»å‹ | è¯´æ˜ (Description) |
| :--- | :--- | :--- |
| **id** | UUID | ç»„ä»¶å®ä¾‹ IDã€‚ |
| **canvas_id** | UUID | æ‰€å±ç”»å¸ƒé¡µé¢ ID (`canvas_pages`)ã€‚ |
| **widget_type** | String | `'calendar_master'`, `'smart_list'`, `'matrix'`, `'detail'`, `'time_line'`ã€‚ |
| **geometry** | JSONB | `{ x, y, w, h, z }` ç‰©ç†ä½ç½®ä¸å±‚çº§ã€‚ |
| **data_source_config** | JSONB | **[å¤§è„‘]** å®šä¹‰ç»„ä»¶çš„æ•°æ®æŸ¥è¯¢é€»è¾‘ã€‚ä¾‹å¦‚ `{ "filter": { "do_date": "today" } }`ã€‚ |
| **view_state** | JSONB | å†…éƒ¨çŠ¶æ€ã€‚ä¾‹å¦‚ `{ "is_pinned": true, "view_mode": "week" }`ã€‚ |
| **group_id** | UUID | æ‰€å±åˆ†ç»„ï¼Œç»„å†…æ•°æ®è®¢é˜… |

------

## 4. ç”»å¸ƒç»„ä»¶ä½“ç³» (Canvas Components)

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæ‰€æœ‰åŠŸèƒ½æ¨¡å—å‡è¢«å°è£…ä¸º**ç‹¬ç«‹çš„ã€å¯å®ä¾‹åŒ–çš„æµ®åŠ¨çª—å£ (Floating Widgets)**ã€‚å®ƒä»¬çš„æ•°æ®çŠ¶æ€æŒä¹…åŒ–äº `canvas_widgets` è¡¨ä¸­ï¼Œé€šè¿‡ RxDB åœ¨å®¢æˆ·ç«¯å®æ—¶æ¸²æŸ“ã€‚

### 4.1 ç»„ä»¶é€šç”¨ç‰©ç†å±æ€§ (Common Physics)

æ‰€æœ‰ç»„ä»¶å®ä¾‹ï¼ˆæ— è®ºæ˜¯æ—¥å†è¿˜æ˜¯åˆ—è¡¨ï¼‰éƒ½å…±äº«ä¸€å¥—åŸºç¡€çš„â€œå¤–æ¡†â€äº¤äº’é€»è¾‘ä¸æ•°æ®ç»“æ„ï¼š

-   **Header Bar (æ ‡é¢˜æ )**ï¼š
    -   **Title**ï¼šæ˜¾ç¤ºå½“å‰ä¸Šä¸‹æ–‡ï¼ˆå¦‚ "Nov 20" æˆ– projectåç§°"Apollo"ï¼‰ã€‚
    -   **Pin Button (ğŸ“Œ)**ï¼šä¿®æ”¹ `view_state.is_pinned`ã€‚é”å®šåï¼Œç»„ä»¶ä¸å†å“åº”ä¸Šæ¸¸ä¿¡å·ï¼Œ`data_source_config` è¢«å›ºåŒ–ã€‚
    -   **Add**: åˆ›å»ºåŒç»„ç»„ä»¶ã€‚ä¿¡å·åœ¨ç»„å†…ä¼ é€’ã€‚
    -   **View Switcher**ï¼šä¿®æ”¹ `view_state.view_mode`ï¼ˆå¦‚ List $\leftrightarrow$ Kanbanï¼‰ã€‚
-   **Geometry (å‡ ä½•)**ï¼šå¯¹åº”æ•°æ®åº“ `geometry` JSON å­—æ®µ (`x, y, w, h`)ã€‚æ”¯æŒè‡ªç”±æ‹–æ‹½ä¸ç¼©æ”¾ã€‚
-   **Z-Index (å±‚çº§)**ï¼šç‚¹å‡»ç»„ä»¶æ—¶è‡ªåŠ¨ç½®é¡¶ (æ›´æ–° `geometry.z`)ã€‚æ”¯æŒæ‰‹åŠ¨â€œç½®åº•â€ä½œä¸ºèƒŒæ™¯æ¿ã€‚

### 4.2 ç»„ä»¶å®ä¾‹æ•°æ®æ¨¡å‹ (The Widget Schema)

è¿™æ˜¯å‰ç«¯ RxDB ä¸­ `canvas_widgets` é›†åˆå­˜å‚¨çš„å®é™… JSON ç»“æ„ï¼Œå®ƒæ˜¯è§†å›¾æ¸²æŸ“çš„å”¯ä¸€ä¾æ®ï¼š

```TypeScript
interface CanvasWidget {
  id: string;
  widget_type: 'calendar_master' | 'smart_list' | 'matrix' | 'detail' | 'project_header' | 'archive_bin';
  
  // ç‰©ç†ä½ç½®
  geometry: { x: number, y: number, w: number, h: number, z: number };
  
  // [The Brain] æ•°æ®é©±åŠ¨æ ¸å¿ƒï¼šå†³å®šè¿™ä¸ªç»„ä»¶æ˜¾ç¤ºä»€ä¹ˆæ•°æ®
  data_source_config: {
    source_type: 'filter' | 'context' | 'static'; 
    criteria: {
      do_date?: string;           // e.g., '2025-11-21'
      project_id?: string;        // e.g., 'uuid-...'
      system_status?: string[];   // e.g., ['active']
      sort_by?: string;           // e.g., 'priority'
    }
  };

  // è§†å›¾å†…éƒ¨çŠ¶æ€
  view_state: {
    is_pinned: boolean;           // æ˜¯å¦é”å®š
    view_mode: string;            // e.g., 'month', 'week', 'kanban'
  };
}
```

### 4.3 æ ¸å¿ƒç»„ä»¶è¯¦è§£ (Core Widgets)

#### A. ä¸»æ§æ—¥å† (Master Calendar)

-   **Type**: `calendar_master`
-   **æ•°æ®é€»è¾‘**: ç›‘å¬å…¨å±€æ—¶é—´èŒƒå›´ã€‚æŸ¥è¯¢ `data_items` ä¸­è½åœ¨å½“å‰è§†å£çš„ Task å’Œ Eventã€‚
-   **è§†è§‰å½¢æ€**:
    -   **Event**: å®å¿ƒè‰²å— (Hard Time)ã€‚
    -   **Task**: åœ†ç‚¹æˆ–ç´§å‡‘æ¡ç›® (Soft Time)ã€‚
    -   **Alert**: è‹¥ `do_date > due_date`ï¼Œæ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å· âš ï¸ã€‚
-   **äº¤äº’**: ä¸»è¦çš„**ä¿¡å·å‘å°„æº**ã€‚ç‚¹å‡»æ—¥æœŸæ ¼æ—¶ï¼Œå¹¿æ’­ `{ date: '...' }` ä¿¡å·ï¼Œè§¦å‘æœªé”å®šä¸‹æ¸¸ç»„ä»¶æ›´æ–° `data_source_config`ã€‚
-   **è§†å›¾åˆ‡æ¢ï¼š**åˆ‡æ¢è‡³å‘¨è§†å›¾

#### B. æ™ºèƒ½åˆ—è¡¨ (Smart List)

-   **Type**: `smart_list`
-   **æ•°æ®é€»è¾‘**: æœ€é€šç”¨çš„å®¹å™¨ã€‚æ ¹æ® `config.criteria` æ¸²æŸ“åˆ—è¡¨ã€‚
-   **è§†è§‰å½¢æ€**:
    -   **Priority**: æ¸²æŸ“ `properties.priority`ï¼Œé«˜ä¼˜æ˜¾ç¤ºå·¦ä¾§çº¢æ¡ã€‚
    -   **Energy**: æ¸²æŸ“ `properties.energy_level`ï¼Œæ˜¾ç¤º ğŸ”‹ / â˜•ï¸ å›¾æ ‡ã€‚
    -   **Ghosts**: è‡ªåŠ¨åœ¨é¡¶éƒ¨åŒ…å«â€œå·²é€¾æœŸâ€çš„ä»»åŠ¡ï¼ˆå³ä½¿å½“å‰è¿‡æ»¤æ¡ä»¶æ˜¯â€œä»Šå¤©â€ï¼‰ã€‚
-   **æ’åº**: æ··åˆæ’åº `sort_order` (æ‰‹åŠ¨) $\rightarrow$ `priority` $\rightarrow$ `energy` $\rightarrow$ `due_date`ã€‚

#### C. è¯¦æƒ…æ£€æŸ¥å™¨ (Detail Inspector)

-   **Type**: `detail`
-   **æ•°æ®é€»è¾‘**: ç»‘å®šå•ä¸ª `item_id`ã€‚
-   **å½¢æ€**: å…¨å­—æ®µç¼–è¾‘å™¨ã€‚
    -   **Context Aware**: ç”»å¸ƒä¸Šé€šå¸¸ä¿ç•™ä¸€ä¸ª**æœªé”å®š**çš„è¯¦æƒ…ç»„ä»¶ã€‚å½“ç”¨æˆ·åœ¨æ—¥å†æˆ–åˆ—è¡¨ä¸­ç‚¹å‡»ä»»æ„ä»»åŠ¡æ—¶ï¼Œè¯¥ç»„ä»¶ä¼šè‡ªåŠ¨åˆ·æ–°å†…å®¹ï¼ˆå¤ç”¨çª—å£ï¼‰ï¼Œè€Œä¸æ˜¯ä¸æ–­å¼¹å‡ºæ–°çª—å£ã€‚

### 4.4 å¤åˆä¸ç‰¹æ®Šç»„ä»¶ (Compound & Special Widgets)

è¿™äº›ç»„ä»¶åœ¨é€»è¾‘ä¸Šæ›´å¤æ‚ï¼Œå¯èƒ½ç”±å¤šä¸ª Widget ç»„åˆè€Œæˆã€‚

#### E. é¡¹ç›®ç»„åˆè§†å›¾ (Project)

-   **è§¦å‘**: ç”¨æˆ·åœ¨ smart list ä¸­åˆ‡æ¢è‡³ Projectï¼Œå³å¯æ–°å»ºé¡¹ç›®ï¼Œå¯åœ¨ calendar ä¸­æ–°å»º Project Header ç”¨äºå±•ç¤ºé¡¹ç›®ä¸»è¦ä¿¡æ¯
-   é€‰ä¸­æŸä¸ª Project å³å¯åœ¨ç»„å†…å¹¿æ’­é¡¹ç›®ä¿¡å·ï¼Œåœ¨ Project Header å’Œ Smart List ä¸­å±•ç¤ºé¡¹ç›®çš„ä¸»è¦ä¿¡æ¯å’Œå­ä»»åŠ¡ã€‚
-   é€‰ä¸­æŸä¸ªæ—¥æœŸæˆ–æœˆä»½ï¼ŒProject Header ä¹Ÿä¼šæ¥æ”¶ä¿¡å·å¹¶æ˜¾ç¤ºå½“æ—¥/å½“æœˆçš„ä¿¡æ¯
-   å½“å‰ç‰ˆæœ¬çš„é¡¹ç›®æ›´åŠ ç±»ä¼¼äºâ€œæ ‡ç­¾â€çš„å®šä¹‰ã€‚

#### F. å½’æ¡£ä¸æ”¶é›†ç®± (System Bins)

-   **Inbox (æ”¶é›†ç®±)**
    -   **æœ¬è´¨**: ä¸€ä¸ªé…ç½®äº†ç‰¹æ®Šè¿‡æ»¤å™¨çš„ `smart_list`ã€‚
    -   **Config**: `{ criteria: { do_date: null, system_status: 'active' } }`ã€‚
    -   **äº¤äº’**: ä½œä¸ºâ€œæœªæ’ç¨‹æ± â€ã€‚ä»»åŠ¡ä¸€æ—¦è¢«æ‹–å‡ºåˆ°æ—¥å†ï¼ˆè¢«èµ‹äºˆ `do_date`ï¼‰ï¼Œå³ä¸ç¬¦åˆè¿‡æ»¤æ¡ä»¶ï¼Œè‡ªåŠ¨ä»ç®±ä¸­æ¶ˆå¤±ã€‚
-   **Archive (å½’æ¡£ç®±)**
    -   **Type**: `archive_bin`
    -   **å½¢æ€**: é»˜è®¤æ˜¯ä¸€ä¸ªå›¾æ ‡ï¼ˆç¢çº¸æœº/é»‘æ´ï¼‰ï¼Œå¯å±•å¼€ä¸ºåˆ—è¡¨ã€‚
    -   **ç‰©ç†äº¤äº’**:
        -   **Delete**: å°†ä»»ä½• Item æ‹–å…¥æ­¤ç»„ä»¶ï¼Œè§¦å‘ `update({ system_status: 'archived' })` ã€‚
        -   **Lazy Load**: å±•å¼€åˆ—è¡¨æ—¶ï¼Œè§¦å‘æœåŠ¡ç«¯ SQL æŸ¥è¯¢ï¼ˆå†·æ•°æ®ä¸å…¨é‡åŒæ­¥åˆ° RxDBï¼‰ã€‚


-----

## 5. äº¤äº’ä¸ä¿¡å·æµè½¬é€»è¾‘ (Interaction & Signal Flow)

æœ¬ç« èŠ‚å®šä¹‰äº†ç»„ä»¶ä¹‹é—´å¦‚ä½•é€šè¿‡**â€œå‘å¸ƒ/è®¢é˜…â€ (Pub/Sub)** æœºåˆ¶è¿›è¡Œé€šè®¯ï¼Œä»¥åŠç”¨æˆ·çš„ç©ºé—´æ“ä½œï¼ˆæ‹–æ‹½ã€é”å®šï¼‰å¦‚ä½•è½¬åŒ–ä¸ºåº•å±‚çš„æ•°æ®åº“å˜æ›´ã€‚

åœ¨ v6.0 æ¶æ„ä¸­ï¼Œäº¤äº’çš„æ ¸å¿ƒä¸å†æ˜¯ç®€å•çš„äº‹ä»¶å†’æ³¡ï¼Œè€Œæ˜¯ **â€œä¿®æ”¹é…ç½® $\rightarrow$ ååº”å¼æŸ¥è¯¢â€** çš„å¾ªç¯ï¼š

1.  ä¸Šæ¸¸ç»„ä»¶ä¿®æ”¹è‡ªèº«çš„é€‰ä¸­çŠ¶æ€ (`selection_state`)ã€‚
2.  æ§åˆ¶å™¨æ ¹æ® `canvas_links` æ‰¾åˆ°ä¸‹æ¸¸ç»„ä»¶ã€‚
3.  æ§åˆ¶å™¨ä¿®æ”¹ä¸‹æ¸¸ç»„ä»¶çš„ `data_source_config`ã€‚
4.  RxDB è‡ªåŠ¨æ£€æµ‹åˆ°é…ç½®å˜æ›´ï¼Œé‡æ–°è¿è¡ŒæŸ¥è¯¢å¹¶æ¸²æŸ“è§†å›¾ã€‚

### 5.1 ä¿¡å·æºä¸å“åº”è§„åˆ™ (Signal Source & Response Map)

ç»„ä»¶é—´çš„è”åŠ¨æœ¬è´¨ä¸Šæ˜¯ä¸Šæ¸¸ç»„ä»¶åŠ¨æ€æ”¹å†™ä¸‹æ¸¸ç»„ä»¶çš„ `JSON Query`ã€‚

| ä¸Šæ¸¸æ“ä½œ (Source Action) | ä¿¡å·å«ä¹‰ (Payload) | ä¸‹æ¸¸ç»„ä»¶å“åº” (Downstream RxDB Query Update) | ä¸šåŠ¡åœºæ™¯ |
| :--- | :--- | :--- | :--- |
| **Calendar: ç‚¹å‡»æ—¥æœŸ**<br>*(e.g., Select 'Nov 20')* | `{ type: 'date', val: '2025-11-20' }` | **æ›´æ–°è¿‡æ»¤æ¡ä»¶**: <br>`config.criteria = { do_date: '2025-11-20' }` | èšç„¦å¤„ç†æŸä¸€å¤©çš„ä»»åŠ¡åˆ—è¡¨ã€‚ |
| **Calendar: åˆ‡æ¢å‘¨è§†å›¾**<br>*(e.g., View range Nov 17-23)* | `{ type: 'range', start: '...', end: '...' }` | **æ›´æ–°èŒƒå›´è¿‡æ»¤**: <br>`config.criteria = { do_date: { $gte: start, $lte: end } }` | æŸ¥çœ‹æœ¬å‘¨æ•´ä½“å·¥ä½œé‡ã€‚ |
| **Calendar: ç‚¹å‡» Event**<br>*(e.g., Select 'Meeting A')* | `{ type: 'context', id: 'evt_001' }` | **æ›´æ–°çˆ¶çº§è¿‡æ»¤**: <br>`config.criteria = { parent_id: 'evt_001' }` | æŸ¥çœ‹è¯¥æ—¥ç¨‹ä¸‹çš„å­ä»»åŠ¡ï¼ˆå¦‚ä¼šè®®çºªè¦ï¼‰ã€‚ |
| **List: é€‰ä¸­ä»»åŠ¡ A**<br>*(e.g., Select 'Task A')* | `{ type: 'item', id: 'task_001' }` | **æ›´æ–°è¯¦æƒ…ç»‘å®š**: <br>`config.criteria = { id: 'task_001' }` | **è¯¦æƒ…æ£€æŸ¥å™¨ (Detail Inspector)** åŠ è½½è¯¥ä»»åŠ¡æ•°æ®ã€‚ |
| **Project List: é€‰ä¸­é¡¹ç›®**<br>*(e.g., Select 'Project Apollo')* | `{ type: 'project', id: 'proj_001' }` | **æ›´æ–°é¡¹ç›®è¿‡æ»¤**: <br>`config.criteria = { parent_id: 'proj_001' }` | é’»å–æŸ¥çœ‹è¯¥é¡¹ç›®å†…çš„æ‰€æœ‰ä»»åŠ¡ã€‚ |

### 5.2 ç”»å¸ƒè§†è§‰åé¦ˆ (Spatial Visual Feedback)

åœ¨æ— é™ç”»å¸ƒä¸Šï¼Œç”¨æˆ·å¿…é¡»ç›´è§‚åœ°æ„ŸçŸ¥åˆ°â€œè°æ§åˆ¶ç€è°â€ã€‚è¿™ä¾èµ–äº `canvas_links` è¡¨çš„æ•°æ®æ¸²æŸ“ã€‚

1.  **è¿æ¥çº¿ (The Umbilical Cord)**ï¼š
      * **æ•°æ®åŸºç¡€**: æ¯ä¸€æ¡ `canvas_links` è®°å½•æ¸²æŸ“ä¸ºä¸€æ¡è´å¡å°”æ›²çº¿ã€‚
      * **æœªé”å®šæ€ (Live)**: å®çº¿ï¼Œé¢œè‰²è·Ÿéš UI ä¸»é¢˜è‰²ï¼ˆè¡¨ç¤ºæ•°æ®å®æ—¶æµé€šï¼‰ã€‚
      * **é”å®šæ€ (Pinned)**: è¿æ¥çº¿æ–­å¼€ã€å˜ä¸ºè™šçº¿æˆ–åŠé€æ˜ï¼ˆè¡¨ç¤ºå…³ç³»å·²â€œå¿«ç…§åŒ–â€æˆ–æš‚æ—¶æ–­å¼€ï¼‰ã€‚
    
2.  **é€‰ä¸­é«˜äº® (Active Highlighting)**ï¼š
      * å½“ç”¨æˆ·ç‚¹å‡»ä¸‹æ¸¸ç»„ä»¶ï¼ˆå¦‚ List Bï¼‰æ—¶ï¼Œç³»ç»ŸæŸ¥è¯¢ `canvas_links` æ‰¾åˆ°å…¶ Source Widgetï¼ˆå¦‚ Calendar Aï¼‰ã€‚
      * **æ•ˆæœ**: Source Widget çš„è¾¹æ¡†å‘å‡ºå¾®å…‰ (Glow Effect)ï¼Œæç¤ºç”¨æˆ·ï¼šâ€œå½“å‰åˆ—è¡¨çš„æ•°æ®æ˜¯ç”±è¿™ä¸ªæ—¥å†å†³å®šçš„â€ã€‚

### 5.3 é”å®šä¸å¿«ç…§æœºåˆ¶ (Pinning & Snapshot)

è¿™æ˜¯è§£å†³â€œæ•°æ®ä¿®æ”¹åæ¶ˆå¤±â€é—®é¢˜çš„æ ¸å¿ƒé€»è¾‘ã€‚

  * **çŠ¶æ€ A: è®¢é˜…æ¨¡å¼ (Linked/Unpinned)**

      * `view_state.is_pinned = false`ã€‚
      * **è¡Œä¸º**: ä¸‹æ¸¸ç»„ä»¶å®æ—¶ç›‘å¬ä¸Šæ¸¸ä¿¡å·ã€‚
      * *ä¾‹å­*: æ—¥å†é€‰â€œä»Šå¤©â€ï¼Œåˆ—è¡¨æ˜¾ç¤ºâ€œä»Šå¤©â€ã€‚æ—¥å†åˆ‡â€œæ˜å¤©â€ï¼Œåˆ—è¡¨å˜â€œæ˜å¤©â€ã€‚

  * **çŠ¶æ€ B: é”å®šæ¨¡å¼ (Pinned/Snapshot)**

      * **è§¦å‘**: ç”¨æˆ·ç‚¹å‡» ğŸ“Œ æŒ‰é’®ã€‚
      * **ç³»ç»ŸåŠ¨ä½œ**:
        1.  `view_state.is_pinned` è®¾ä¸º `true`ã€‚
        2.  **å¿«ç…§åŒ– (Snapshotting)**: è·å–å½“å‰åˆ—è¡¨æ‰€æœ‰å¯è§ Item çš„ IDã€‚
        3.  **é…ç½®å†»ç»“**: å°† `data_source_config` ä»â€œåŠ¨æ€è¿‡æ»¤â€ (`criteria: { do_date: '...' }`) ä¿®æ”¹ä¸ºâ€œé™æ€é›†åˆâ€ (`criteria: { id: { $in: [id1, id2...] } }`)ã€‚
      * **ä¸šåŠ¡ä»·å€¼**: æ­¤æ—¶å³ä½¿ä¿®æ”¹ä»»åŠ¡æ—¥æœŸï¼ˆä½¿å…¶ä¸å†ç¬¦åˆåŸæŸ¥è¯¢æ¡ä»¶ï¼‰ï¼Œä»»åŠ¡**ä¹Ÿä¸ä¼šæ¶ˆå¤±**ã€‚å®ƒåªæ˜¯ç•™åœ¨äº†è¿™ä¸ªâ€œä¸´æ—¶å¿«ç…§åˆ—è¡¨â€ä¸­ï¼Œç›´åˆ°ç”¨æˆ·æ‰‹åŠ¨ç§»é™¤æˆ–åˆ·æ–°ã€‚

### 5.4 ç©ºé—´æ‹–æ‹½é€»è¾‘ (Spatial Drag & Drop)

æ‹–æ‹½æ˜¯ä¿®æ”¹ `data_items` å±æ€§æœ€é«˜æ•ˆçš„æ–¹å¼ã€‚ä»¥ä¸‹è¡¨æ ¼å®šä¹‰äº†æ‹–æ‹½äº‹ä»¶è§¦å‘çš„ RxDB æ›´æ–°é€»è¾‘ã€‚

| æ‹–æ‹½æº (Source) | æ”¾ç½®ç›®æ ‡ (Drop Target) | ä¸šåŠ¡è¯­ä¹‰ | åº•å±‚æ•°æ®å˜æ›´ (RxDB Update) |
| :--- | :--- | :--- | :--- |
| **List Item** | **Calendar (æ—¥æœŸæ ¼)** | **æ’ç¨‹ (Schedule)** | `doc.atomicPatch({ do_date: targetDate, start_time: null })` |
| **List Item** | **Calendar (æ—¶é—´è½´)** | **æ—¶é—´å— (Time Block)** | `doc.atomicPatch({ do_date: targetDate, start_time: dropTime, end_time: dropTime + 1h })` |
| **Calendar Item** | **Inbox Component** | **å–æ¶ˆæ’ç¨‹ (Unschedule)** | `doc.atomicPatch({ do_date: null, start_time: null })` <br>*(ä»æ—¥å†ä¸Šç§»é™¤ï¼Œå›åˆ°â€œæœªå®‰æ’â€çŠ¶æ€)* |
| **List Item** | **Same List (ä¸Šä¸‹ç§»åŠ¨)** | **æ‰‹åŠ¨æ’åº (Reorder)** | **ç®—æ³•**: è®¡ç®—å‰åä¸¤ä¸ª Item çš„ `sort_order` å‡å€¼ã€‚<br>`doc.atomicPatch({ sort_order: newRank })` |
| **List Item** | **Matrix Q1 (å³ä¸Š)** | **å˜æ›´ä¸ºé‡è¦/ç´§æ€¥** | `doc.atomicPatch({ properties: { priority: 'high' }, do_date: today })` |
| **List Item** | **Matrix Q4 (å·¦ä¸‹)** | **å˜æ›´ä¸ºä¸é‡è¦/ä¸ç´§æ€¥** | `doc.atomicPatch({ properties: { priority: 'low' }, system_status: 'active' })` |
| **Any Item** | **Archive Box** | **å½’æ¡£** | `doc.atomicPatch({ system_status: 'archived', completed_at: now() })` |


-----

## 6\. è‡ªåŠ¨åŒ–ä¸ä¸šåŠ¡è§„åˆ™ (Automation & Business Logic)

æœ¬ç« èŠ‚å®šä¹‰äº†ç³»ç»Ÿçš„â€œéšå½¢ç®¡å®¶â€é€»è¾‘ã€‚åœ¨ Local-First æ¶æ„ä¸‹ï¼Œè‡ªåŠ¨åŒ–è§„åˆ™è¢«æ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

1.  **UI å“åº”å¼è§„åˆ™ (Client-Side)**ï¼šåŸºäº RxDB çš„å®æ—¶è®¡ç®—ï¼Œè´Ÿè´£è§†å›¾è¿‡æ»¤ã€çŠ¶æ€æ¨å¯¼å’Œå³æ—¶åé¦ˆã€‚
2.  **æ•°æ®å®ˆæŠ¤è§„åˆ™ (Server-Side)**ï¼šåŸºäº PostgreSQL çš„å®šæ—¶ä»»åŠ¡ (Cron Jobs)ï¼Œè´Ÿè´£æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å’Œé‡å‹åˆ†æã€‚

### 6.1 æ—¶é—´ç»´åº¦çš„è‡ªåŠ¨åŒ– (Temporal Automation)

å¤„ç†æ—¶é—´æµé€å¸¦æ¥çš„çŠ¶æ€å˜æ›´ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯**â€œæ¶ˆé™¤è¿‡æœŸç„¦è™‘â€**ã€‚

#### A. é€¾æœŸå¹½çµè§†å›¾ (Overdue Ghost Projection) â€”â€” *[Client-Side RxDB]*

  * **ç—›ç‚¹è§£å†³**: é˜²æ­¢â€œæ˜¨æ—¥æœªå®Œä»»åŠ¡â€å› æ—¥æœŸå˜æ›´è€Œä»â€œä»Šæ—¥åˆ—è¡¨â€ä¸­æ¶ˆå¤±ï¼Œå¯¼è‡´é—å¿˜ã€‚
  * **å®ç°é€»è¾‘**: åœ¨æ‰€æœ‰é…ç½®ä¸ºâ€œæ˜¾ç¤ºä»Šæ—¥ä»»åŠ¡â€çš„ `smart_list` ç»„ä»¶ä¸­ï¼ŒRxDB æŸ¥è¯¢ä¼šè‡ªåŠ¨æ³¨å…¥â€œå¹½çµæ¡ä»¶â€ã€‚
  * **æŸ¥è¯¢æ„é€  (Query Construction)**:
    
    ```javascript
    // ä¼ªä»£ç ï¼šç”Ÿæˆ RxDB Selector
    {
      selector: {
        $or: [
          { do_date: '2025-11-21' }, // ä»Šå¤©
          { 
            do_date: { $lt: '2025-11-21' }, // è¿‡å»
            system_status: 'active'         // ä¸”æ²¡åšå®Œ
          }
        ]
      }
    }
    ```
  * **è§†è§‰è¡¨ç°**: å¹½çµä»»åŠ¡ (Ghosts) å¼ºåˆ¶ç½®é¡¶ï¼ŒèƒŒæ™¯å¸¦æœ‰çº¢è‰²åŠé€æ˜çº¹ç†ï¼Œæ˜¾ç¤ºæ ‡ç­¾ "3 days ago"ã€‚

#### B. æ™ºèƒ½é€¾æœŸè­¦å‘Š (Smart Overdue Alert) â€”â€” *[UI Computed]*

  * **è§„åˆ™**: å½“ç”¨æˆ·çš„â€œæ’ç¨‹æ„æ„¿â€è¿èƒŒäº†â€œå¤–éƒ¨æ­»çº¿â€æ—¶ï¼Œç³»ç»Ÿå‘å‡ºè­¦å‘Šã€‚
  * **è®¡ç®—å…¬å¼**:
    $$\text{Alert Level} = (\text{do\_date} > \text{due\_date}) \ ? \ \text{CRITICAL} \ : \ \text{NORMAL}$$
  * **è¡¨ç°**:
      * **æ—¥å†/åˆ—è¡¨**: ä»»åŠ¡æ˜¾ç¤ºé†’ç›®çš„çº¢è‰²è™šçº¿è¾¹æ¡†æˆ– âš ï¸ å›¾æ ‡ã€‚
      * **è¯¦æƒ…é¡µ**: Date Picker åŒºåŸŸæ˜¾ç¤ºæ–‡å­—æç¤º "Scheduled date is past the deadline\!"ã€‚

#### C. ç´§æ€¥åº¦åŠ¨æ€è¯„åˆ† (Dynamic Urgency Score) â€”â€” *[Matrix Widget Logic]*

  * **ç”¨é€”**: å†³å®šè‰¾æ£®è±ªå¨å°”çŸ©é˜µä¸­ä»»åŠ¡åœ¨ X è½´ï¼ˆç´§æ€¥åº¦ï¼‰çš„ç‰©ç†åæ ‡ã€‚
  * **ç®—æ³•**:
      * $DaysLeft = due\_date - today$
      * $X\_Position = \text{Clamp}( \frac{1}{DaysLeft}, \ 0, \ 100 )$
  * **åŠ¨æ€æ•ˆæœ**: éšç€æ—¶é—´æ¨ç§»ï¼ˆ$DaysLeft$ å˜å°ï¼‰ï¼Œæœªå®Œæˆçš„ä»»åŠ¡ä¼šåœ¨çŸ©é˜µè§†å›¾ä¸­**è‡ªåŠ¨å‘å³æ¼‚ç§»**ï¼Œæœ€ç»ˆè¶Šè¿‡ä¸­çº¿å˜ä¸ºâ€œç´§æ€¥â€ã€‚

### 6.2 ç»“æ„ç»´åº¦çš„è‡ªåŠ¨åŒ– (Structural Automation)

ç»´æŠ¤ Project - Task - Event ä¹‹é—´çš„å±‚çº§å¥åº·ã€‚

#### A. åƒµå°¸é¡¹ç›®æ£€æµ‹ (Zombie Project Detection) â€”â€” *[Server-Side SQL]*

  * **å®šä¹‰**: ä¸€ä¸ªå¤„äº `active` çŠ¶æ€çš„é¡¹ç›®ï¼Œä½†å…¶ä¸‹æ²¡æœ‰ä»»ä½• `active` æˆ– `waiting` çš„å­ä»»åŠ¡ï¼ˆå³ç¼ºä¹ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼‰ã€‚
  * **å®ˆæŠ¤è¿›ç¨‹**: æ¯æ—¥å‡Œæ™¨è¿è¡Œ SQL æ‰«æã€‚
    ```sql
    -- æ‰¾å‡ºåƒµå°¸é¡¹ç›® ID
    SELECT P.id, P.user_id 
    FROM data_items P
    WHERE P.entity_type = 'project' 
      AND P.system_status = 'active'
      AND P.deleted = FALSE
      -- æ ¸å¿ƒé€»è¾‘ï¼šä¸å­˜åœ¨ Active æˆ– Waiting çš„å­ä»»åŠ¡
      AND NOT EXISTS (
        SELECT 1 FROM data_items T 
        WHERE T.parent_id = P.id 
          AND T.system_status IN ('active', 'waiting')
          AND T.deleted = FALSE
      )
    ```
  * **ç³»ç»Ÿè¡Œä¸º**:
      * ä¸ç›´æ¥ä¿®æ”¹æ•°æ®ã€‚
      * æˆ‘ä»¬åˆ©ç”¨ properties å­—æ®µå­˜å‚¨ç³»ç»Ÿæç¤º
      * `properties: { system_alert: 'zombie_state' }`

#### B. é¡¹ç›®è‡ªåŠ¨å®Œæˆå»ºè®® (Project Completion Prompt) â€”â€” *[Client-Side Logic]*

  * **è§¦å‘æ—¶æœº**: å½“ç”¨æˆ·å‹¾é€‰å®ŒæˆæŸä¸ª Project ä¸‹çš„**æœ€åä¸€ä¸ª** Active Task æ—¶ã€‚
  * **äº¤äº’**: å¼¹å‡º Toast æç¤º â€”â€” *"é¡¹ç›® [Project Name] ä¼¼ä¹å·²æ¸…ç©ºï¼Œæ˜¯å¦å°†å…¶æ ‡è®°ä¸ºå®Œæˆï¼Ÿ"*
  * **åŠ¨ä½œ**: ç‚¹å‡»â€œæ˜¯â€è§¦å‘ `update({ id: project_id, system_status: 'completed' })`ã€‚

### 6.3 å±æ€§ç»§æ‰¿ä¸è¡ç”Ÿé€»è¾‘ (Inheritance & Derivation)

å‡å°‘ç”¨æˆ·è¾“å…¥ï¼Œé€šè¿‡ä¸Šä¸‹æ–‡è‡ªåŠ¨å¡«å…… `properties`ã€‚

#### A. ä»æ—¥ç¨‹è¡ç”Ÿä»»åŠ¡ (Event-to-Task)

  * **åœºæ™¯**: åœ¨æ—¥å†çš„ Event ä¸Šå³é”®é€‰æ‹© "Create Prep Task" (åˆ›å»ºå‡†å¤‡ä»»åŠ¡)ã€‚
  * **è‡ªåŠ¨å¡«å……è§„åˆ™**:
    1.  `parent_id`: ç»§æ‰¿ Event çš„ ID (æˆ– Event æ‰€å±çš„ Project ID)ã€‚
    3.  `do_date`: é»˜è®¤ä¸º Event **å¼€å§‹å‰ä¸€å¤©**ã€‚
    4.  `due_date`: ä¸¥æ ¼è®¾ä¸º Event çš„ **start\_time**ã€‚


-----

## 7. æ•°æ®æŸ¥è¯¢æ¥å£è§„èŒƒ (Data Query Interface Specs)

æœ¬ç« èŠ‚å®šä¹‰äº†å‰ç«¯è§†å›¾ï¼ˆCalendar, List, Matrixï¼‰å¦‚ä½•è·å–æ•°æ®ã€‚
åœ¨ **Local-First** æ¶æ„ä¸‹ï¼Œ**90% çš„æŸ¥è¯¢åœ¨å®¢æˆ·ç«¯ (RxDB)** é’ˆå¯¹æœ¬åœ° IndexedDB æ‰§è¡Œï¼›ä»…**å½’æ¡£æ£€ç´¢**å’Œ**å¢é‡åŒæ­¥**æ¶‰åŠæœåŠ¡ç«¯ APIã€‚

**é¢„è®¾å˜é‡**:

  * `$currentUserId`: å½“å‰ç™»å½•ç”¨æˆ· UUID
  * `$viewStart`, `$viewEnd`: å½“å‰è§†å›¾æ—¶é—´çª—å£ (ISO String)
  * `$today`: ä»Šæ—¥æ—¥æœŸ (YYYY-MM-DD)

### 7.1 ä¸»æ§æ—¥å†è§†å›¾ (Master Calendar Query) â€”â€” *[Client: RxDB]*

æ—¥å†ç»„ä»¶éœ€è¦ä¸€æ¬¡æ€§æ‹‰å–è§†å£å†…çš„â€œç¡¬æ—¥ç¨‹â€ã€â€œè½¯ä»»åŠ¡â€ä»¥åŠâ€œéšå½¢ç‚¸å¼¹â€ï¼ˆæœªæ’ç¨‹ä½†å³å°†åˆ°æœŸçš„ä»»åŠ¡ï¼‰ã€‚

```javascript
// Collection: data_items
// ç›®çš„: æ¸²æŸ“ Month/Week è§†å›¾
const calendarQuery = {
  selector: {
    user_id: $currentUserId,
    system_status: { $ne: 'archived' }, // æ’é™¤å½’æ¡£ï¼Œæ˜¾ç¤º Completed ä»¥ä¾¿åˆ’æ‰
    $or: [
      // A. ç¡¬æ—¥ç¨‹ (Event): è½åœ¨æ—¶é—´èŒƒå›´å†…
      {
        entity_type: 'event',
        start_time: { $gte: $viewStart, $lte: $viewEnd }
      },
      // B. è½¯ä»»åŠ¡ (Task): è®¡åˆ’åœ¨è¯¥æ—¶é—´æ®µåš
      {
        entity_type: 'task',
        do_date: { $gte: $viewStart, $lte: $viewEnd }
      },
      // C. éšå½¢ç‚¸å¼¹ (Task): æ— è®¡åˆ’æ—¥æœŸï¼Œä½†æ­»çº¿è½åœ¨èŒƒå›´å†…
      {
        entity_type: 'task',
        do_date: null,
        due_date: { $gte: $viewStart, $lte: $viewEnd }
      }
    ]
  },
  // æ’åº: ä¼˜å…ˆæŒ‰å¼€å§‹æ—¶é—´/è®¡åˆ’æ—¥æœŸæ¸²æŸ“
  sort: [{ start_time: 'asc' }, { do_date: 'asc' }]
};
```

### 7.2 æ™ºèƒ½åˆ—è¡¨è§†å›¾ (Smart List Query) â€”â€” *[Client: RxDB]*

è¿™æ˜¯æœ€å¤æ‚çš„æŸ¥è¯¢ï¼ŒåŒ…å«â€œé€¾æœŸå¹½çµâ€é€»è¾‘ã€ä¸Šä¸‹æ–‡è¿‡æ»¤ä»¥åŠæ··åˆæ’åºã€‚

```javascript
// Collection: data_items
// ç›®çš„: æ¸²æŸ“ "Today" æˆ–ç‰¹å®šæ—¥æœŸçš„åˆ—è¡¨
const listQuery = {
  selector: {
    user_id: $currentUserId,
    entity_type: 'task',
    system_status: { $in: ['active', 'waiting'] },
    
    // 1. æ ¸å¿ƒè¿‡æ»¤: é€‰ä¸­æ—¥æœŸ OR (å¦‚æœæ˜¯ä»Šå¤©ï¼Œåˆ™åŒ…å«å†å²é€¾æœŸ)
    $or: [
      { do_date: $selectedDate },
      // å¹½çµé€»è¾‘ (Ghosts): è¿‡å»æœªå®Œæˆçš„ä»»åŠ¡è‡ªåŠ¨æŠ•å°„åˆ°ä»Šå¤©
      { 
        do_date: { $lt: $today }, 
        system_status: 'active' 
      }
    ],

    // 2. å±æ€§è¿‡æ»¤ (åŸºäº JSONB æ‰å¹³åŒ–ç´¢å¼•)
    // æ³¨æ„: è‹¥ schema ä¸­ properties æœªå®šä¹‰ä¸ºé¡¶å±‚ç´¢å¼•ï¼Œéœ€åœ¨å†…å­˜ä¸­è¿‡æ»¤
    'properties.energy_level': { $eq: $energyFilter } // Optional
  },
  
  // 3. æ··åˆæ’åºç­–ç•¥
  // RxDB æ’åºé™åˆ¶: æ’åºå­—æ®µå¿…é¡»åœ¨ Selector ä¸­æˆ–æœ‰ç´¢å¼•ã€‚
  // å®é™…å®ç°ä¸­ï¼Œé€šå¸¸å…ˆ fetch å†ç”± UI ç»„ä»¶è¿›è¡Œå¤æ‚æ’åº(Sort Order > Priority > Due Date)
  sort: [
    { sort_order: 'asc' }, // ç”¨æˆ·æ‰‹åŠ¨æ‹–æ‹½é¡ºåºä¼˜å…ˆ
    { due_date: 'asc' }    // å…¶æ¬¡æŒ‰æ­»çº¿
  ]
};
```

### 7.4 æœåŠ¡ç«¯åŒæ­¥ä¸å®ˆæŠ¤æ¥å£ (Server-Side SQL)

è¿™äº› SQL è¿è¡Œåœ¨ NestJS åç«¯ï¼Œç›´æ¥æ“ä½œ PostgreSQLã€‚

#### A. å¢é‡åŒæ­¥æ¥å£ (Sync Pull)

å‰ç«¯ RxDB å‘èµ· pull è¯·æ±‚æ—¶è°ƒç”¨ã€‚

```sql
-- GET /api/sync/pull?checkpoint=2025-11-20T10:00:00Z
SELECT 
  id, user_id, entity_type, title, system_status, 
  do_date, due_date, start_time, end_time,
  properties, updated_at, deleted 
FROM data_items
WHERE user_id = :userId
  AND updated_at > :checkpoint
ORDER BY updated_at ASC
LIMIT :batchSize;
```

#### B. åƒµå°¸é¡¹ç›®æ£€æµ‹ (Daemon Job)

åå°å®šæ—¶ä»»åŠ¡ï¼Œç”¨äºå‘ç°éœ€è¦ç»´æŠ¤çš„æ•°æ®ã€‚

```sql
-- æ‰¾å‡º Active ä½†æ²¡æœ‰ Active å­ä»»åŠ¡çš„é¡¹ç›®
SELECT P.id, P.user_id
FROM data_items P
WHERE P.entity_type = 'project' 
  AND P.system_status = 'active'
  AND P.deleted = FALSE
  AND NOT EXISTS (
    SELECT 1 FROM data_items T 
    WHERE T.parent_id = P.id 
      AND T.system_status IN ('active', 'waiting')
      AND T.deleted = FALSE
  );
```

### 7.5 å…¨å±€å½’æ¡£æ£€ç´¢ (Global Archive Search) â€”â€” *[Server API]*

å½’æ¡£æ•°æ®å±äºâ€œå†·æ•°æ®â€ï¼Œä¸å…¨é‡åŒæ­¥åˆ°æœ¬åœ° IndexedDBï¼Œè€Œæ˜¯é€šè¿‡ REST API åˆ†é¡µæ‹‰å–ã€‚

*(æš‚æœªå®ç°)*
<!--
```sql
-- GET /api/items/archive?page=1&q=keyword
SELECT * FROM data_items
WHERE user_id = :userId
  AND system_status IN ('completed', 'dropped', 'archived')
  AND deleted = FALSE
  -- æ”¯æŒç®€å•çš„æ–‡æœ¬æœç´¢
  AND (:keyword IS NULL OR title ILIKE :keyword)
ORDER BY completed_at DESC -- æœ€è¿‘å®Œæˆçš„åœ¨æœ€å‰
LIMIT 50 OFFSET :offset;
```
-->

-----

## 8. UI ç»„ä»¶è§„èŒƒä¸äº¤äº’è¯¦è§£ (UI Specifications)

æœ¬ç« èŠ‚å®šä¹‰äº†å‰ç«¯ç»„ä»¶çš„è¯¦ç»†äº¤äº’è¡Œä¸ºã€‚åœ¨ Local-First æ¶æ„ä¸‹ï¼Œæ‰€æœ‰äº¤äº’å¿…é¡»éµå¾ª **â€œç«‹å³åé¦ˆï¼Œåå°åŒæ­¥â€** çš„åŸåˆ™ã€‚

### 8.1 é€šç”¨å¤–æ¡†æ§åˆ¶å™¨ (Common Frame Controls)

æ‰€æœ‰ç»„ä»¶å®ä¾‹ï¼ˆ`canvas_widgets`ï¼‰å‡åŒ…è£¹åœ¨ä¸€ä¸ªç»Ÿä¸€çš„å®¹å™¨ (Wrapper) ä¸­ï¼Œè¯¥å®¹å™¨è´Ÿè´£å¤„ç†ç‰©ç†å±æ€§ã€‚

| UI å…ƒç´  | è§¦å‘æ“ä½œ (Trigger) | æ•°æ®/è§†å›¾å“åº” (Response) |
| :--- | :--- | :--- |
| **Drag Handle**<br>(æ ‡é¢˜æ ç©ºç™½å¤„) | æ‹–æ‹½ (Drag) | **å®æ—¶ç§»åŠ¨**ï¼š<br>1. æ›´æ–° DOM `transform: translate(...)`.<br>2. èŠ‚æµ (Throttle 200ms) ä¿å­˜ï¼š`widget.atomicPatch({ geometry: { x, y } })`ã€‚<br>3. è‡ªåŠ¨ç½®é¡¶ï¼š`z-index ++`ã€‚ |
| **Resize Handle**<br>(å³ä¸‹è§’) | æ‹–æ‹½ (Drag) | **è°ƒæ•´å°ºå¯¸**ï¼š<br>æ›´æ–° `geometry.w / h`ã€‚æŸäº›ç»„ä»¶ï¼ˆå¦‚åˆ—è¡¨ï¼‰ä¼šæ ¹æ®å®½åº¦è‡ªåŠ¨åˆ‡æ¢ Compact/Full æ¨¡å¼ã€‚ |
| **Pin Toggle**<br>(ğŸ“Œ å›¾æ ‡) | å•å‡» | **åˆ‡æ¢é”å®š (Freeze State)**ï¼š<br>1. **Lock**: `view_state.is_pinned = true`ã€‚ç»„ä»¶åœæ­¢ç›‘å¬ä¸Šæ¸¸ä¿¡å·ï¼ŒSnapshot å½“å‰æ•°æ®ã€‚<br>2. **Unlock**: `view_state.is_pinned = false`ã€‚ç»„ä»¶é‡æ–°è®¢é˜…ä¸Šæ¸¸ä¿¡å·ï¼Œå¹¶ç«‹å³æ‰§è¡Œä¸€æ¬¡ Refreshã€‚ |
| **Add**<br>(â• å›¾æ ‡) | å•å‡» | **æ–°å»ºä¸‹æ¸¸ç»„ä»¶ (Transaction)**ï¼š<br>1. å¼¹å‡ºèœå•é€‰æ‹©ä¸‹æ¸¸ç±»å‹ (e.g., "Linked List")ã€‚<br>2. **DB Action**: å¹¶åœ¨å½“å‰ç»„ä»¶å³ä¾§ `x+width+20` å¤„åˆ›å»ºä¸€ä¸ªæ–° Widget è®°å½•ã€‚<br>3. **Link Action**: åˆ›å»ºä¸€æ¡ `canvas_links` è®°å½•ã€‚<br>4. **Visual**: è‡ªåŠ¨ç»˜åˆ¶è¿æ¥çº¿ã€‚ |
| **Close**<br>(âœ– å›¾æ ‡) | å•å‡» | **é”€æ¯**ï¼š<br>æ‰§è¡Œ `widget.remove()`ã€‚è¿™ä»…åˆ é™¤è§†å›¾å®ä¾‹ï¼Œ**ç»ä¸åˆ é™¤**ä¸šåŠ¡æ•°æ® (`data_items`)ã€‚ |

---

### 8.2 æ™ºèƒ½åˆ—è¡¨è§†å›¾ (Smart List View)

åˆ—è¡¨æ˜¯äº¤äº’æœ€é«˜é¢‘çš„åŒºåŸŸï¼Œéœ€æ”¯æŒé”®ç›˜æ“ä½œå’Œå¿«é€Ÿç¼–è¾‘ã€‚

#### A. å·¥å…·æ  (Toolbar)
* **[Sort Btn]**: ä¸‹æ‹‰èœå•ã€‚ç›´æ¥ä¿®æ”¹ RxDB Query çš„ `sort` å­—æ®µã€‚
* **[+ Add Task]**:
    * **Action**: åœ¨åˆ—è¡¨åº•éƒ¨çš„ Input Rowã€‚
    * **Save**: å›è½¦è§¦å‘ `items.insert({ title: input, do_date: currentContextDate, ... })`ã€‚

#### B. åˆ—è¡¨é¡¹ (List Item Row)

æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ª Task æ–‡æ¡£ã€‚

| åŒºåŸŸ/å…ƒç´  | åŠ¨ä½œ | äº¤äº’ç»†èŠ‚ä¸æ•°æ®å˜æ›´ |
| :--- | :--- | :--- |
| **Checkbox** | å•å‡» | **ä¹è§‚å®Œæˆ (Optimistic Completion)**ï¼š<br>1. **UI**: ç«‹å³æ’­æ”¾æ‰“é’©åŠ¨ç”»ï¼Œæ–‡å­—å˜ç°åˆ’æ‰ã€‚<br>2. **DB**: `doc.atomicPatch({ system_status: 'completed', completed_at: now() })`ã€‚ |
| **Title Text** | å•å‡» | **é€‰ä¸­ä¿¡å·**ï¼š<br>1. **UI**: è¯¥è¡Œé«˜äº®ã€‚<br>2. **Signal**: å¹¿æ’­ `{ type: 'item', id: doc.id }`ã€‚å¦‚æœç”»å¸ƒä¸Šæœ‰æœªé”å®šçš„ Detail Widgetï¼Œå®ƒä¼šç«‹å³æ˜¾ç¤ºè¯¥ä»»åŠ¡è¯¦æƒ…ã€‚ |
| **Drag Grip**<br>(::before) | æ‹–æ‹½å¼€å§‹ | **å¯åŠ¨æ¬è¿**ï¼š<br>1. ç”ŸæˆåŠé€æ˜ Ghost Imageã€‚<br>2. ç”»å¸ƒä¸Šæ‰€æœ‰å¯æ¥å— Drop çš„åŒºåŸŸï¼ˆæ—¥å†æ ¼ã€çŸ©é˜µè±¡é™ã€å½’æ¡£ç®±ï¼‰é«˜äº®æ˜¾ç¤º (Drop Zones Highlight)ã€‚ |

---

### 8.3 ä¸»æ§æ—¥å† (Master Calendar)

æ—¥å†æ˜¯ä¸»è¦çš„ä¿¡å·å‘å°„æºå’ŒæŠ•æ”¾ç›®æ ‡ã€‚

#### A. æ—¥æœŸç½‘æ ¼ (Date Cell)

| åŠ¨ä½œ | å“åº” |
| :--- | :--- |
| **å•å‡»ç©ºç™½å¤„** | **å‘å°„ä¿¡å·**ï¼š<br>å¹¿æ’­ `{ date: 'YYYY-MM-DD' }`ã€‚ä¸‹æ¸¸åˆ—è¡¨åˆ·æ–°ã€‚ |
| **åŒå‡»ç©ºç™½å¤„** | **å¿«é€Ÿåˆ›å»º**ï¼š<br>åœ¨æ ¼å†…å¼¹å‡º Popover Inputã€‚åˆ›å»º `do_date = æ­¤æ ¼æ—¥æœŸ` çš„æ–°ä»»åŠ¡ã€‚ |
| **æ¥æ”¶ Drop** | **æ’ç¨‹ (Schedule)**ï¼š<br>1. è·å–è¢«æ‹–å…¥ Item çš„ UUIDã€‚<br>2. **DB**: `doc.atomicPatch({ do_date: targetDate })`ã€‚<br>3. **UI**: Item ç«‹å³å‡ºç°åœ¨è¯¥æ ¼å†…ã€‚ |

#### B. æ—¥ç¨‹å—/ä»»åŠ¡ç‚¹ (Event Block / Task Dot)
| åŠ¨ä½œ | å“åº” |
| :--- | :--- |
| **å•å‡»** | **å‘å°„ä¸Šä¸‹æ–‡ä¿¡å·**ï¼š<br>å¹¿æ’­ `{ context_id: doc.id }`ã€‚å¸¸ç”¨äºæŸ¥çœ‹ Event å…³è”çš„ Prep Tasksã€‚ |
| **æ‹–æ‹½è¾¹ç¼˜**<br>(Event only) | **è°ƒæ•´æ—¶é•¿**ï¼š<br>å®æ—¶æ›´æ–° `end_time`ã€‚æ¾æ‰‹æ—¶æäº¤ DBã€‚ |
| **æ‹–æ‹½ç§»åŠ¨** | **é‡æ–°æ’ç¨‹**ï¼š<br>ä» 20å· æ‹–åˆ° 22å· $\rightarrow$ æ›´æ–° `start_time` æˆ– `do_date`ã€‚ |

---

### 8.4 è¯¦æƒ…æ£€æŸ¥å™¨ (Detail Inspector)

| æ§ä»¶ | äº¤äº’è§„èŒƒ |
| :--- | :--- |
| **Auto Save** | æ‰€æœ‰è¾“å…¥æ¡† (Title, Note) å‡é‡‡ç”¨ **Debounce (500ms)** è‡ªåŠ¨ä¿å­˜æœºåˆ¶ã€‚å³ä¸Šè§’æ˜¾ç¤º "Saving..." / "Saved" çŠ¶æ€æŒ‡ç¤ºå™¨ã€‚ |
| **Date Picker** | åŒ…å« `Do Date` (è®¡åˆ’) å’Œ `Due Date` (æ­»çº¿)ã€‚<br>ä¿®æ”¹ `Do Date` æ—¶ï¼Œå¦‚æœç”»å¸ƒä¸Šæœ‰æ—¥å†ç»„ä»¶ï¼Œæ—¥å†ä¸Šçš„å°åœ†ç‚¹åº”**å®æ—¶è·³åŠ¨**åˆ°æ–°æ—¥æœŸã€‚ |
| **Project Select** | ä¸‹æ‹‰æœç´¢æ¡†ã€‚æ”¯æŒåˆ›å»ºæ–° Projectã€‚ |
| **Sub-tasks** | ç®€å•çš„ Checklistã€‚æ•°æ®å­˜å‚¨åœ¨ `properties.checklist` JSON æ•°ç»„ä¸­ï¼Œä¸ä½œä¸ºç‹¬ç«‹ Item å­˜å‚¨ï¼Œä»¥å‡è½»æ•°æ®åº“å‹åŠ›ã€‚ |

---

### 8.5 å½’æ¡£ç®± (Archive Box)

| çŠ¶æ€ | åŠ¨ä½œ | å“åº” |
| :--- | :--- | :--- |
| **Icon Mode**<br>(é»˜è®¤) | æ¥æ”¶ Drop | **ç²‰ç¢æ•ˆæœ (Shredder)**ï¼š<br>1. æ’­æ”¾ç¢çº¸æœºéŸ³æ•ˆ/åŠ¨ç”»ã€‚<br>2. **DB**: `update({ system_status: 'completed' })`ã€‚<br>3. **Undo**: åº•éƒ¨å¼¹å‡º Toast "Task Completed (Undo)" æŒç»­ 3ç§’ã€‚ |
| **List Mode**<br>(å±•å¼€å) | æ»šåŠ¨åˆ°åº•éƒ¨ | **æ— é™åŠ è½½ (Infinite Scroll)**ï¼š<br>è§¦å‘ API è¯·æ±‚ `GET /api/archive?page=N`ã€‚å°†å†·æ•°æ®è¿½åŠ åˆ°æœ¬åœ°ä¸´æ—¶åˆ—è¡¨ç¼“å­˜ä¸­ã€‚ |

-----

## 9. ç”¨æˆ·æ—…ç¨‹ä¸å†·å¯åŠ¨ (User Journey & Cold Start)

æœ¬ç« èŠ‚æè¿°ç”¨æˆ·é¦–æ¬¡è¿›å…¥ç³»ç»Ÿæ—¶çš„é»˜è®¤çŠ¶æ€ï¼Œä»¥åŠå®Œæˆç¬¬ä¸€ä¸ªæ ¸å¿ƒé—­ç¯ï¼ˆCapture $\rightarrow$ Schedule $\rightarrow$ Review $\rightarrow$ Focusï¼‰çš„æ ‡å‡†å‰§æœ¬ã€‚

### 9.1 é»˜è®¤åˆå§‹åŒ–çŠ¶æ€ (The Default Layout)

å½“æ–°ç”¨æˆ·æ³¨å†Œå®Œæˆå¹¶é¦–æ¬¡ç™»å½•æ—¶ï¼ŒæœåŠ¡ç«¯ (NestJS) ä¼šå‘ `canvas_pages` å’Œ `canvas_widgets` è¡¨ä¸­å†™å…¥ä¸€å¥—â€œæœ€ä½³å®è·µâ€é¢„è®¾æ•°æ®ï¼ŒéšååŒæ­¥è‡³å®¢æˆ·ç«¯ RxDBã€‚

**é»˜è®¤ç”»å¸ƒé…ç½®**:
1.  **Widget A: ä¸»æ§æ—¥å† (Master Calendar)**
    * **Type**: `calendar_master`
    * **Geometry**: `{ x: 40, y: 40, w: 800, h: 600 }` (å æ®å·¦ä¾§ä¸»è§†åŒº)
    * **State**: æ˜¾ç¤ºå½“å‰æœˆä»½ã€‚

2.  **Widget B: æ”¶é›†ç®± (Inbox / Unscheduled)**
    * **Type**: `smart_list`
    * **Geometry**: `{ x: 860, y: 40, w: 350, h: 400 }` (å³ä¸Šè§’)
    * **Config**: `{ criteria: { do_date: null, system_status: 'active' } }`
    * **è¯´æ˜**: è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„åˆ—è¡¨ç»„ä»¶ï¼Œä½†é€šè¿‡é…ç½®ä¸“é—¨ç”¨äºæ•è·â€œæ— æ—¶é—´æ„å›¾â€çš„æƒ³æ³•ã€‚

3.  **Widget C: å½’æ¡£ç®± (The Shredder)**
    * **Type**: `archive_bin`
    * **Geometry**: `{ x: 860, y: 460, w: 350, h: 180 }` (å³ä¸‹è§’)
    * **State**: æ”¶èµ·çŠ¶æ€ (Icon Mode)ã€‚

---

### 9.2 åœºæ™¯ A: æ•è·ä¸æ’ç¨‹ (Capture & Schedule)

**ç›®æ ‡**ï¼šå°†è„‘æµ·ä¸­çš„æ‚äº‹ï¼ˆæ— ç»“æ„ï¼‰è½¬åŒ–ä¸ºç³»ç»Ÿä¸­çš„è®¡åˆ’ï¼ˆæœ‰ç»“æ„ï¼‰ã€‚

1.  **æ•è· (Capture)**ï¼š
    * **ç”¨æˆ·åŠ¨ä½œ**: åœ¨å³ä¾§ Widget B (Inbox) ç‚¹å‡» `[+ Add]`ï¼Œè¾“å…¥ "ä¹°èœ"ï¼Œå›è½¦ã€‚
    * **RxDB Action**: `items.insert({ title: 'ä¹°èœ', do_date: null, entity_type: 'task' })`ã€‚
    * **è§†å›¾å“åº”**: ä»»åŠ¡ç«‹å³å‡ºç°åœ¨ Inbox åˆ—è¡¨ä¸­ã€‚

2.  **æ’ç¨‹ (Drag & Drop)**ï¼š
    * **ç”¨æˆ·åŠ¨ä½œ**: æŒ‰ä½ "ä¹°èœ" ä»»åŠ¡ï¼Œå°†å…¶æ‹–å…¥å·¦ä¾§æ—¥å†çš„ **23å·** æ ¼å­ã€‚
    * **RxDB Action**:
        ```javascript
        // è§¦å‘åŸå­æ›´æ–°
        doc.atomicPatch({ do_date: '2025-11-23' });
        ```
    * **è§†å›¾å“åº” (Reactive Update)**:
        * **Inbox**: ç”±äº `do_date` ä¸å†æ˜¯ `null`ï¼Œè¯¥ä»»åŠ¡ä¸å†ç¬¦åˆ Widget B çš„è¿‡æ»¤æ¡ä»¶ $\rightarrow$ **ç¬é—´æ¶ˆå¤±**ã€‚
        * **Calendar**: 23å·æ ¼å­ç›‘å¬åˆ°æ•°æ®å˜æ›´ $\rightarrow$ **å‡ºç°** "ä¹°èœ" çš„åœ†ç‚¹/æ¡ç›®ã€‚

---

### 9.3 åœºæ™¯ B: è¯¦æƒ…æŸ¥çœ‹ä¸â€œçª—å£å¤ç”¨â€ç­–ç•¥ (Window Reuse)

**ç›®æ ‡**ï¼šé¿å…â€œå¼¹çª—çˆ†ç‚¸â€ã€‚ç³»ç»Ÿæ™ºèƒ½åˆ¤æ–­æ˜¯å¤ç”¨ç°æœ‰çª—å£è¿˜æ˜¯æ–°å»ºçª—å£ã€‚

1.  **æŸ¥çœ‹ä»»åŠ¡ A**:
    * **ç”¨æˆ·åŠ¨ä½œ**: ç‚¹å‡»æ—¥å†ä¸Š 23å· çš„ "ä¹°èœ"ã€‚
    * **ç³»ç»Ÿé€»è¾‘**:
        1.  æ‰«æ `canvas_widgets`ã€‚
        2.  å¯»æ‰¾ `type == 'detail'` ä¸” `view_state.is_pinned == false` çš„ç»„ä»¶ã€‚
        3.  **ç»“æœ**: æœªæ‰¾åˆ° (å†·å¯åŠ¨ç¬¬ä¸€æ¬¡)ã€‚
    * **ç³»ç»Ÿå“åº”**:
        * åœ¨ `x: 860, y: 40` (è¦†ç›–åœ¨ Inbox ä¸Šæ–¹) **æ–°å»º**ä¸€ä¸ª Detail Widgetã€‚
        * è®¾ç½®å…¶ `config.item_id = 'task_buy_milk'`ã€‚

2.  **åˆ‡æ¢ä»»åŠ¡ B**:
    * **ç”¨æˆ·åŠ¨ä½œ**: ç‚¹å‡»æ—¥å†ä¸Š 25å· çš„ "é˜…è¯»"ã€‚
    * **ç³»ç»Ÿé€»è¾‘**:
        1.  æ‰«æå‘ç°åˆšæ‰åˆ›å»ºçš„ Detail Widget æ­£å¤„äº **æœªé”å®š (Unpinned)** çŠ¶æ€ã€‚
    * **ç³»ç»Ÿå“åº”**:
        * **ä¸æ–°å»ºçª—å£**ã€‚
        * ç›´æ¥æ›´æ–°è¯¥ Widget çš„é…ç½®: `config.item_id = 'task_reading'`ã€‚
        * å†…å®¹ç¬é—´ä» "ä¹°èœ" åˆ·æ–°ä¸º "é˜…è¯»"ã€‚

---

### 9.4 åœºæ™¯ C: é”å®šä¸å¤šçª—å£å¹¶è¡Œ (Pinning & Multi-Window)

**ç›®æ ‡**ï¼šä¿ç•™å½“å‰ä¸Šä¸‹æ–‡ï¼ˆå‚è€ƒèµ„æ–™ï¼‰ï¼ŒåŒæ—¶å¤„ç†å¦ä¸€ä¸ªä»»åŠ¡ã€‚

1.  **é”å®šä¸Šä¸‹æ–‡**:
    * **ç”¨æˆ·åŠ¨ä½œ**: å†³å®šæ­¤æ—¶éœ€è¦å¯¹ç€ "é˜…è¯»" çš„ç¬”è®°è¿›è¡Œæ€è€ƒã€‚ç‚¹å‡» Detail Widget å³ä¸Šè§’çš„ **ğŸ“Œ (Pin)**ã€‚
    * **RxDB Action**: `widget_detail.atomicPatch({ view_state: { is_pinned: true } })`ã€‚
    * **UI åé¦ˆ**: å³ä¸Šè§’çš„ **ğŸ“Œ (Pin)**å˜å®å¿ƒã€‚æ­¤æ—¶å®ƒåˆ‡æ–­äº†ä¸æ—¥å†çš„ä¿¡å·ç›‘å¬ã€‚

2.  **å†æ¬¡æŸ¥çœ‹ä»»åŠ¡ A**:
    * **ç”¨æˆ·åŠ¨ä½œ**: å†æ¬¡ç‚¹å‡»æ—¥å†ä¸Šçš„ "ä¹°èœ"ã€‚
    * **ç³»ç»Ÿé€»è¾‘**:
        1.  æ‰«æ `canvas_widgets`ã€‚
        2.  å‘ç°å”¯ä¸€çš„ Detail Widget å·²è¢« **é”å®š (Pinned)**ã€‚
        3.  **ç»“æœ**: æ— å¯ç”¨å¤ç”¨çª—å£ã€‚
    * **ç³»ç»Ÿå“åº”**:
        * åœ¨å±å¹•æ™ºèƒ½ç©ºä½ (Smart Placement) **æ–°å»º** ç¬¬äºŒä¸ª Detail Widgetã€‚
        * åŠ è½½ "ä¹°èœ" çš„æ•°æ®ã€‚
    * **æœ€ç»ˆçŠ¶æ€**: å±å¹•ä¸ŠåŒæ—¶å­˜åœ¨ "é˜…è¯»" (é”å®šå‚è€ƒ) å’Œ "ä¹°èœ" (å½“å‰ç¼–è¾‘) ä¸¤ä¸ªçª—å£ã€‚

---

### 9.5 åœºæ™¯ D: æ·±åº¦é’»å–ä¸åŒç»„å…³è”

**ç›®æ ‡**ï¼šä»å®è§‚æœˆè§†å›¾è¿›å…¥å¾®è§‚æ—¥è§†å›¾ï¼Œä½“éªŒ v6.0 çš„ç»„ä»¶è”åŠ¨ã€‚

1.  **å±•å¼€æŸæ—¥**:
    * **ç”¨æˆ·åŠ¨ä½œ**: åœ¨æ—¥å†ä¸Šç‚¹å‡» **23å·** æ—¥æœŸæ ¼ï¼ˆéä»»åŠ¡ï¼‰ã€‚
    * **ç³»ç»Ÿå“åº”**:
        * åˆ›å»ºåŒç»„å…³è”ç»„ä»¶ `Widget D (Smart List)`ã€‚
        * åŒç»„é»˜è®¤å…³è”ï¼Œå¯è¿›è¡Œæ•°æ®è®¢é˜…: `Link: Calendar -> Widget D`ã€‚
        * åˆå§‹åŒ–é…ç½®: `Widget D.config = { criteria: { do_date: '2025-11-23' } }`ã€‚
    * **è§†è§‰ç»“æœ**: æ—¥å†æ—å‡ºç°äº†ä¸€ä¸ªåªæ˜¾ç¤º "23å·ä»»åŠ¡" çš„åˆ—è¡¨ã€‚

2.  **åŒç»„è”åŠ¨éªŒè¯**:
    * æ­¤æ—¶ç”»å¸ƒä¸Šæœ‰ï¼š`Calendar`, `List (23rd)`, å’Œä¸€ä¸ªæœªé”å®šçš„ `Detail Widget`ã€‚
    * **è·¯å¾„ 1**: ç‚¹å‡» `List (23rd)` ä¸­çš„ "ä¹°èœ" $\rightarrow$ `Detail Widget` åˆ·æ–°ã€‚
    * **è·¯å¾„ 2**: ç‚¹å‡» `Calendar` ä¸­çš„ "ä¹°èœ" $\rightarrow$ `Detail Widget` åˆ·æ–°ã€‚
    * **é€»è¾‘æ€»ç»“**: åªè¦ç»„ä»¶æœªé”å®šï¼Œå®ƒå°±æ˜¯æ•´ä¸ªç”»å¸ƒæ•°æ®çš„**â€œå…¬å…±æŠ•å½±ä»ªâ€**ï¼Œä»»ä½•ä¸Šæ¸¸ç»„ä»¶çš„ç‚¹å‡»éƒ½ä¼šå°†å†…å®¹æŠ•å°„åˆ°å®ƒä¸Šé¢ã€‚
